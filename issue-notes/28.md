# issue 直近24時間でuser commitがあるかどうか、のチェックを、workflowのjobs先頭に新規jobを追加して実施し、本体jobの先頭にneedsを書く #28
[issues #28](https://github.com/cat2151/github-actions/issues/28)

# これまでの課題は？
- これまでは各workflow内の終盤のscriptにバラバラに実装されていたので、
    - ムダにcheckout等、各種処理が走っていた

# 対策案は？
- 直近24時間でuser commitがあるかどうか、
    - のチェックを、
        - workflowのjobs先頭に新規jobを追加して実施し、
            - 本体jobの先頭にneedsを書く
- この対策で、各workflow先頭にこれを書くだけでよくなり、エコになる想定

# ChatGPTに生成させた
## 呼び出し元のサンプル
- 実際には、共通workflowのjobsの先頭付近を、このサンプルを参考に書き換えるイメージ
```
jobs:
  check_recent_human_commit:
    uses: ./.github/workflows/check-recent-human-commit.yml

  build:
    needs: check_recent_human_commit
    if: needs.check_recent_human_commit.outputs.has_recent_human_commit == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Run build
        run: echo "Building because there is a recent human commit!"
```
## 共通ワークフロー側の案
- シンプルにmailのみを条件とし、mailも1種類のみに明示する
```
name: "Check recent human commit"

on:
  workflow_call:

jobs:
  check-recent-human-commit:
    runs-on: ubuntu-latest
    outputs:
      has_recent_human_commit: ${{ steps.check.outputs.has_recent_human_commit }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check recent human commit
        id: check
        run: |
          set -e

          HAS_HUMAN=false

          while IFS=$'\x01' read -r HASH NAME EMAIL SUBJECT; do
            SUBJECT="${SUBJECT%$'\x02'}"

            if [[ ! "$EMAIL" =~ ^41898282\+github-actions\[bot\]@users\.noreply\.github\.com$ ]]; then
              echo "HUMAN: Commit $HASH | Author: $NAME <$EMAIL> | Message: $SUBJECT"
              HAS_HUMAN=true
              break
            else
              echo "BOT: Commit $HASH | Author: $NAME <$EMAIL> | Message: $SUBJECT"
            fi
          done <<< "$(git log --since="24 hours ago" --pretty=format:'%H%x01%an%x01%ae%x01%s%x02')"

          if [ "$HAS_HUMAN" = true ]; then
            echo "Found recent human commit."
            echo "has_recent_human_commit=true" >> $GITHUB_OUTPUT
          else
            echo "No human commits in last 24h."
            echo "has_recent_human_commit=false" >> $GITHUB_OUTPUT
```
## 備忘
- 上記はChatGPTに生成させ、それをレビューさせて改善させる、のサイクルで生成した。
    - 一発で生成はできなかった
    - ChatGPTが自分で生成したものに対して自己レビューでミスや改善点が多発していた
        - ブレも発生し、二転三転気味でもあり、
            - ハルシネーションに近い低品質状態だと感じた
                - これは経験則からの感覚的なもの
    - 生成の品質が低い、ということ
        - LLMはまだ学習不足、github-actions workflow yml の学習不足である、と解釈する
        - shell scriptの生成品質も低いかも。
            - もともとshell scriptで複雑なlogicを書くとtest costが高い、なぜなら読みづらいから。
                - なのでロジックをcjs側に切り出したほうが安全かもしれない。
                    - それはtestしてから検討とする

# どうする？
- 前提
    - これは、ほぼリファクタリングである
        - mailの条件は仕様変更ではあるが、
            - 割り切る。
                - 影響範囲は「仕様変更後24hの間は誤爆する」程度なので。
- よって、ほかのtest redがtest greenになるのを待つ、切り分ける、のが適切である、と判断する
- よって、#27 を先に完了させる
- のち、これを実装してtestする
