
name: Issue Note Generator

on:
  workflow_call:
    inputs:
      issue_title:
        required: true
        type: string
      issue_number:
        required: true
        type: string
      issue_body:
        required: true
        type: string
      issue_html_url:
        required: true
        type: string

jobs:
  create-issue-note:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up unnecessary issue notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const notesDir = path.join(process.cwd(), 'issue-notes');
            if (!fs.existsSync(notesDir)) {
              core.info('issue-notes directory does not exist; skipping cleanup.');
              return;
            }

            const files = fs.readdirSync(notesDir).filter((file) => file.endsWith('.md'));
            const deletions = [];

            for (const file of files) {
              const issueNumber = Number(path.basename(file, '.md'));
              if (Number.isNaN(issueNumber)) {
                core.info(`Skipping non-numeric note file: ${file}`);
                continue;
              }

              const content = fs.readFileSync(path.join(notesDir, file), 'utf8');
              const lines = content.split(/\r?\n/);
              const remainingContent = lines.slice(2).join('\n').trim();

              if (remainingContent.length > 0) {
                continue;
              }

              let issueState;
              try {
                const { data } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                issueState = data.state;
              } catch (error) {
                if (error.status === 404) {
                  issueState = 'missing';
                } else {
                  throw error;
                }
              }

              if (issueState === 'closed' || issueState === 'missing') {
                deletions.push(file);
              }
            }

            for (const file of deletions) {
              fs.unlinkSync(path.join(notesDir, file));
              core.info(`Deleted unnecessary note: ${file}`);
            }

            if (deletions.length === 0) {
              core.info('No unnecessary issue notes found for cleanup.');
            }

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate issue note markdown
        id: generate_md
        run: |
          mkdir -p issue-notes
          echo "# issue ${{ inputs.issue_title }} #${{ inputs.issue_number }}" > issue-notes/${{ inputs.issue_number }}.md
          echo "[issues #${{ inputs.issue_number }}](${{ inputs.issue_html_url }})" >> issue-notes/${{ inputs.issue_number }}.md
          echo "" >> issue-notes/${{ inputs.issue_number }}.md
          echo "${{ inputs.issue_body }}" >> issue-notes/${{ inputs.issue_number }}.md
      - name: Commit and push note
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A issue-notes
          git commit -m "Add issue note for #${{ inputs.issue_number }} [auto]"
          git push

      - name: Add link to issue note in issue body
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_BODY: ${{ inputs.issue_body }}
        with:
          script: |
            const notePath = `issue-notes/${process.env.ISSUE_NUMBER}.md`;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const noteUrl = `https://github.com/${owner}/${repo}/blob/main/${notePath}`;
            const newBody = `[issue-notes/${process.env.ISSUE_NUMBER}.md](${noteUrl})\n\n${process.env.ISSUE_BODY}`;
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: Number(process.env.ISSUE_NUMBER),
              body: newBody
            });
